---
output: 
  word_document:
    reference_docx: cmar_report_template.docx
    toc: true
    toc_depth: 3
editor_options: 
  chunk_output_type: console
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, dpi = 600, fig.width=8, dev = "ragg_png")

library(adcp)
library(canadianmaps)
library(lubridate)
library(ggplot2)
library(ggspatial)
library(readr)
library(dplyr)
library(here)
library(waves)
library(RColorBrewer)
library(sf)
library(tidyr)

theme_set(theme_light())


# library(openair)
# library(ggplot2)
# library(ggspatial)
# library(sf)
# library(ggsflabel)
# library(dplyr)
# library(viridis)
# library(RColorBrewer)
# library(readr)
# library(lubridate)
# library(knitr)
# library(openair)
# library(tidyverse)
# library(flextable)
# library(officer)
```


```{r, echo=FALSE, message=FALSE}

# update this be be a param
dat <- read_csv("R:/data_branches/wave/processed_data/deployment_data/annapolis/new/2020-10-22_Cornwallis NE_AN001.csv")

link <- "https://docs.google.com/spreadsheets/d/1DVfJbraoWL-BW8-Aiypz8GZh1sDS6-HtYCSrnOSW07U/edit#gid=0"

depl_info <- googlesheets4::read_sheet(link, sheet = "Wave Tracking") %>% 
  filter(depl_id == unique(dat$deployment_id))

# path to most recent NSDFA tracking sheet -- update this
path_nsdfa <- file.path(
  "R:/tracking_sheets/2023-11-27 - NSDFA Tracking Sheet.xlsx"
) 

# nsdfa tracking sheet
metadata <- adcp_read_nsdfa_metadata(path_nsdfa) %>% 
  filter(Station_Name == depl_info$station, Depl_Date == depl_info$depl_date)

county <- depl_info$county
depl_id <- depl_info$depl_id
year_utc <- year(depl_info$depl_date)

i = 1 # counter for table
k = 1 # counter for figure number

text_size <- 3.5
crs <- 4326
```

```{r, warning=FALSE}
# set up map params

# import NS counties shapefile and remove NA row (should have 18 rows - 1 for each county)
ns <- read_sf(here("data/ns/Merged_Counties2.shp")) %>%
  na.omit() %>%
  # add column with "1" for county of interest and "0" for other counties
  mutate(
    col_county = if_else(County == county, 1, 0),
    col_county = ordered(factor(col_county), levels = c(1, 0))
  ) %>% 
  st_transform(crs = crs) 

bbox <- st_bbox(ns)
bbox[1] <- -66.45 # so that there is water around Digby Neck

nb_pei <- filter(PROV, PT == "NB"|PT=="PE") %>%
  st_transform(crs = crs) %>% 
  mutate(
    col_county = 0, 
    col_county = ordered(factor(col_county), levels = c(1, 0))
  )

can <- bind_rows(
  ns %>% st_simplify(dTolerance = 1000), 
  nb_pei
) %>% 
  st_crop(bbox) 
```

# Introduction

The Centre for Marine Applied Research (CMAR) measures [essential ocean variables](https://goosocean.org/what-we-do/framework/essential-ocean-variables/) around the coast of Nova Scotia through their Coastal Monitoring Program. Through this Program, the Nova Scotia Department of Fisheries and Aquaculture (NSDFA) and CMAR have deployed Acoustic Doppler Current Profilers (ADCPs) at a variety of locations to measure sea state (waves) and currents. This document presents deployment details and summary figures of sea state data collected for deployment **`r depl_id`** in `r county` County (Figure `r k` and Figure `r k+1`). The corresponding current report can be found on the CMAR website [Reports page](https://cmar.ca/reports/).

The data are available for download from the Nova Scotia [Open Data Portal](https://data.novascotia.ca/browse?q=wave&sortBy=relevance). For more information on CMAR and the sea state datasets, visit the [CMAR website](https://cmar.ca/).

This document should be considered as a guide only, as data collection is ongoing. The information may be revised pending ongoing data collection and analyses.

```{r}

ggplot() +
  geom_sf(data = can, aes(fill = col_county)) +
  scale_fill_manual(values = c("#1B9E77", "grey90")) +
  theme_map() +
  coord_sf(expand = FALSE) +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 1),
    text = element_text(size = 12),
    axis.title = element_blank(),
    legend.position = "none"
  )
```
`r cat('\n')`
Figure `r k`: `r county` County (green).


```{r, warning=FALSE, strip.white=TRUE}
k <- k + 1

# station coordinates
station_sf <- st_as_sf(
  metadata, coords = c("Depl_Lon", "Depl_Lat"), crs = crs, agr = "constant"
)

# zoom in area where station is located
ns_crop <- ns %>% 
  st_crop(st_buffer(station_sf, dist = 10000))

ggplot() +
  geom_sf(data = ns_crop) +
  geom_sf(data = station_sf) +
  coord_sf(expand = FALSE) +
  annotation_scale(location = "br") +
  annotation_north_arrow(
    location = "tl", which_north = "true",
    height = unit(1, "cm"),
    width = unit(1, "cm")
  ) +
  theme_map() +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 1)
  )

```
`r cat('\n')`
Figure `r k`:  deployment in `r depl_info$waterbody`.


\newpage
## Data Collection 

CMAR collects wave data using upward facing Acoustic Doppler Current Profilers (ADCPs) mounted on the sea floor. An ADCP uses sound to measure wave orbital velocities over time, which are used to calculate parameters including wave height, wave period, and mean current speed and direction [@RN29849]. CMAR uses several ADCP instrument models, including the Sentinel V20, Sentinel V50, Sentinel V100, and Workhorse Sentinel 600kHz. Each ADCP is typically deployed for 1 - 3 months.

Wave height is the vertical distance between the peak and trough of a wave. The reported wave height is a statistic based on many measurements recorded in a given time interval.

Dp = directioN!

**The results from multiple sound "pings" are averaged over a specified averaging interval to create a time series within a specified ensemble interval. The wave height stati **


One key statistic is the significant wave height (Hs), which is defined as 1) four times the standard deviation of the surface elevation, or 2) as four times the square root of the zeroth-order moment of the wave spectrum. This is about equivalent to another key statistic, the average of the largest one third of waves in the measurement interval (H1/3). Similarly, H1/10 is the average of the largest one tenth of waves in the measurement interval, and Hmax is the height of the largest wave in the interval [@RN29850].

The period (time between waves) for each wave height statistic is also recorded, as well as the mean current speed and direction. For simplicity, only Hs and Hmax and the corresponding periods are presented below. The full wave datasets can be downloaded from the Nova Scotia Open Data Portal. ADCPs also measure current speed and direction at different depths through the water column Current data reports can be found on the CMAR website, and full datasets can be downloaded from the Nova Scotia Open Data Portal.


## Data Terminology & Notes

Ensemble Interval - Time (seconds) between the beginning of one data recording and the next.

Averaging Interval - Time (seconds) over which multiple recordings are taken and averaged during each ensemble.

Pings/Ensemble - Number of individual recordings taken and averaged over the course of the averaging interval.


Dp - Peak wave direction from which the wave is travelling (degrees relative to true north) at the peak period.

**Note:**

All wave data presented in this report are travelling towards the sensor. All compass headings are relative to True North.


\newpage
```{r}
knitr::include_graphics("adcp_report_diagram.png")
k <- k + 1
```

Figure `r k`: Schematic representation of ADCP deployment (not to scale).




\newpage
# `r depl_id` Sea State Data

Table 1: Deployment details for `r depl_id`

```{r}
metadata %>% 
  wv_write_report_table() %>% 
  wv_format_report_table()
```

\newpage
## Wave Height

### Time Series
```{r}
k = k + 1

vars <- c("Hs", "Hmax", "H1/3", "H1/10", "Tp", "Tmax", "T1/3", "T1/10" )

dat_long <- dat %>% 
  pivot_longer(
    cols = all_of(vars), values_to = "value", names_to = "variable"
  )

wv_plot_ts(dat_long) 

```
Figure `r k`: Significant wave height (Hs) and maximum wave height at `r depl_id` deployed in `r year_utc`.

### Frequency
```{r}
k = k + 1

wv_plot_histogram(dat_long, vars = c("Hs", "Hmax"), binwidth = 0.1)

```
Figure `r k`: Histogram of significant wave height and maximum wave height at `r depl_id` deployed in `r year_utc`.


`r knitr::knit_exit()`

\newpage
## Frequency Plots 
Note, zero readings for Figure `r k+1` and Figure `r k+2` have been removed for ease of interpretation. 

```{r, echo = FALSE, message=FALSE, warning=FALSE, error=FALSE, results="asis", eval=TRUE,fig.width=6.5}
k = k+1

ggplot(filter(deployment,Hmax!=0,preserve=TRUE),aes(x=Hmax))+geom_histogram(binwidth =0.01)+xlab("Hmax (m)")
```
Figure `r k`: Frequency of maximum wave height (Hmax) at `r deployment_ID` deployed in `r year`. Plot bin width is 0.01 metres.

\newpage
```{r, echo = FALSE, message=FALSE, warning=FALSE, error=FALSE, results="asis", eval=TRUE,fig.width=6.5}
k = k+1

ggplot(filter(deployment,Hs!=0,preserve=TRUE),aes(x=Hs))+geom_histogram(binwidth =0.01)+xlab("Hs (m)")
```
Figure `r k`: Frequency of significant wave height (Hs) at `r deployment_ID` deployed in `r year`. Plot bin width is 0.01 metres.

```{r, echo = FALSE, message=FALSE, warning=FALSE, error=FALSE, results="asis", eval=TRUE,fig.width=6.5}
k = k+1

ggplot(deployment,aes(x=Tp))+geom_histogram(binwidth = 0.1)+xlab("Tp (s)")

```
Figure `r k`: Frequency of peak wave period (Tp) at `r deployment_ID` deployed in `r year`. Plot bin width is 0.1 seconds.
\newpage

## Wave Rose Plot
```{r, echo = FALSE, results="asis", eval=TRUE,fig.width=7}
k = k+1
if(depl_metadata$Model %in% c("Sentinel V20","Workhorse Sentinel 600kHz", "Sentinel V100","Sentinel V50")){
pollutionRose(deployment,ws="Hs",wd="Dp",
              pollutant = "Hs",
              key.footer="Significant Wave Height (m)",
              annotate=FALSE,
              breaks=c(0, 0.25, 0.5, 0.75,1,1.25,1.5,1.75,2,2.25,2.5,3,4),
              cols="heat")
}else if (depl_metadata$Model %in% c("Xeos Buoy", "MarineLabs Buoy")){
  pollutionRose(deployment,ws="Hs",wd="AverageDirection",
              pollutant = "Hs",
              key.footer="Significant Wave Height (m)",
              annotate=FALSE,
              breaks = c(0, 0.25, 0.5, 0.75,1,1.25,1.5,1.75,2),
              cols="heat")

}


# windRose(deployment, ws="Hs", wd="Dp",
#          breaks=7,
#          increment=0.25,
#          cols = viridis(7),
#          paddle = F,
#          auto.text = F,
#          annotate = F,
#          key.footer = "Significant Wave Height (m)",
#          key.position = "right")


```
Figure `r k`: Frequency of significant wave height (m) by wave direction (Dp or AverageDirection) at `r deployment_ID` deployed in `r year`.

